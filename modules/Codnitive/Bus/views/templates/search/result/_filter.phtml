<?php
$filter = new \app\modules\Codnitive\Bus\blocks\Filter($buses);
$priceData = $filter->getPriceRange($buses);
$priceSteps = $priceData['step'];
$minPrice = $priceData['min'];
$maxPrice = $priceData['max'];

$departingData = $filter->getDepartingRange($buses);
$departingSteps = $departingData['step'];
$minDeparting = $departingData['min'];
$maxDeparting = $departingData['max'] + $departingSteps;
?>

<div class="d-flex bus-filter align-content-center align-items-center justify-content-center box-filter">
    <h3 class="text-center-2 bg-blue"><?= __('bus', 'Filter By') ?></h3>
</div>
<div id="accordion" class="panel panel-primary behclick-panel">
    <div class="panel-body filter">
        <?php /*<script type="text/javascript">
            var rangePicker = new codnitive.rangePicker();
        </script>*/ ?>
        <?php if (($maxPrice - $minPrice) > (2 * $priceSteps)): ?>
        <div class="block">
            <div class="panel-heading ">
                <h4 class="panel-title">
                    <a data-toggle="collapse" href="#collapsePrice" aria-expanded="true">
                    <?= __('bus', 'Price (Rial)') ?><i class="indicator fa fa-caret-down" aria-hidden="true"></i>
                </a>
                </h4>
            </div>
            <div id="collapsePrice" class="panel-collapse collapse show price-block range-slider-wrapper">
                <div id="price_range_slider" class="price-filter-range range_slider" data-filter-group="price">
                </div>
                <input type="text" min="<?= $minPrice ?>" max="<?= $maxPrice - $priceSteps?>" oninput="validity.valid||(value='<?= $minPrice ?>');" value="<?= $minPrice ?>" id="min_price" class="min-field price-range-field slider-range-field" />
                <input type="text" min="<?= $minPrice + $priceSteps ?>" max="<?= $maxPrice ?>" oninput="validity.valid||(value='<?= $maxPrice ?>');" value="<?= $maxPrice ?>" id="max_price" class="max-field price-range-field slider-range-field" />
                <script type="text/javascript">
                    var priceRange = new codnitive.rangePicker();
                    priceRange.init('#price_range_slider', <?= $maxPrice ?>, <?= $minPrice ?>, <?= $priceSteps ?>);
                </script>
            </div>
        </div>
        <?php endif ?>

        <?php if (($maxDeparting - $minDeparting) > (2 * $departingSteps)): ?>
        <div class="block">
            <div class="panel-heading ">
                <h4 class="panel-title">
                    <a data-toggle="collapse" href="#collapseDeparting" aria-expanded="true">
                    <?= __('bus', 'Departing') ?><i class="indicator fa fa-caret-down" aria-hidden="true"></i>
                </a>
                </h4>
            </div>
            <div id="collapseDeparting" class="panel-collapse collapse show departing-block range-slider-wrapper">
                <div id="departing_range_slider" class="departing-filter-range range_slider" data-filter-group="departing">
                </div>
                <input type="text" min="<?= $minDeparting ?>" max="<?= $maxDeparting - $departingSteps?>" oninput="validity.valid||(value='<?= $minDeparting ?>');" value="<?= sprintf('%05s', tools()->formatPrice($minDeparting, 2, ':')) ?>" id="min_departing" class="min-field departing-range-field slider-range-field" disabled="disabled"/>
                <input type="text" min="<?= $minDeparting + $departingSteps ?>" max="<?= $maxDeparting ?>" oninput="validity.valid||(value='<?= $maxDeparting ?>');" value="<?= sprintf('%05s', tools()->formatPrice($maxDeparting, 2, ':')) ?>" id="max_departing" class="max-field departing-range-field slider-range-field" disabled="disabled"/>
                <script type="text/javascript">
                    var departingRange = new codnitive.rangePicker();
                    departingRange.init('#departing_range_slider', <?= $maxDeparting ?>, <?= $minDeparting ?>, <?= $departingSteps ?>, true);
                </script>
            </div>
        </div>
        <?php endif ?>

        <?php /*<div class="block">
            <div class="panel-heading ">
                <h4 class="panel-title">
                    <a data-toggle="collapse" href="#collapse1" aria-expanded="true">
                    <i class="indicator fa fa-caret-down" aria-hidden="true"></i><span>زمان حرکت</span>
                </a>
                </h4>
            </div>
            <div id="collapse1" class="panel-collapse collapse show">
                <ul class="list-group list-grou-time p-2">
                    <li class="d-flex  flex-row justify-content-between">
                        <label class="switch">
                        <input type="checkbox">
                        <span class="slider round"></span>
                    </label>
                        <span class=""> صبح<span class="my-badge">  (ساعت 1 تا 10) </span></span>
                    </li>
                    <li class="d-flex  flex-row justify-content-between">
                        <label class="switch">
                        <input type="checkbox">
                        <span class="slider round"></span>
                    </label>
                        <span class="">   ظهر <span class="my-badge"> (ساعت 10 تا 14)</span></span>
                    </li>
                    <li class="d-flex  flex-row justify-content-between">
                        <label class="switch">
                        <input type="checkbox">
                        <span class="slider round"></span>
                    </label>
                        <span class="">                                         بعد از ظهر <span class="my-badge"> (ساعت 14 تا 18) </span>
                        </span>
                    </li>

                    <li class="d-flex  flex-row justify-content-between">
                        <label class="switch">
                        <input type="checkbox">
                        <span class="slider round"></span>
                    </label> <span class="">شب <span class="my-badge"> (ساعت 18 تا 24) </span></span>
                    </li>
                </ul>
            </div>
        </div>*/ ?>

        <?php $boardingsList = $filter->getBoardingsList() ?>
        <?php if (!empty($boardingsList)): ?>
        <div class="block">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" href="#collapseBoarding" class="collapsed">
                        <i class="indicator fa fa-caret-down" aria-hidden="true" aria-expanded="true"></i>
                        <?= __('bus', 'Origin') ?>
                    </a>
                </h4>
            </div>
            <div id="collapseBoarding" class="panel-collapse collapse filter-group" data-filter-group="boarding">
                <ul class="list-group">
                    <?php foreach ($boardingsList as $boardingEnglish => $boarding): ?>
                    <li class="list-group-item">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" value="<?= $boardingEnglish ?>" data-filter="[data-boarding=<?= $boardingEnglish ?>]">
                                <span class="cr"><i class="cr-icon fa fa-check"></i></span>
                                <span title="<?= __('bus', $boarding) ?>" class="main-blue">
                                    <?= __('bus', $boarding) ?>
                                </span>
                            </label>
                        </div>
                    </li>
                    <?php endforeach; ?>
                </ul>
            </div>
        </div>
        <?php endif ?>


        <?php $droppingsList = $filter->getDroppingsList(); ?>
        <?php if (!empty($droppingsList)): ?>
        <div class="block">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" href="#collapseDropping" class="collapsed">
                        <i class="indicator fa fa-caret-down" aria-hidden="true" aria-expanded="true"></i>
                        <?= __('bus', 'Destination') ?>
                    </a>
                </h4>
            </div>
            <div id="collapseDropping" class="panel-collapse collapse filter-group" data-filter-group="dropping">
                <ul class="list-group">
                    <?php foreach ($droppingsList as $droppingEnglish => $dropping): ?>
                    <li class="list-group-item">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" value="<?= $droppingEnglish ?>" data-filter="[data-dropping=<?= $droppingEnglish ?>]">
                                <span class="cr"><i class="cr-icon fa fa-check"></i></span>
                                <span title="<?= __('bus', $dropping) ?>" class="main-blue">
                                    <?= __('bus', $dropping) ?>
                                </span>
                            </label>
                        </div>
                    </li>
                    <?php endforeach; ?>
                </ul>
            </div>
        </div>
        <?php endif ?>

        <?php $companies = $filter->getCompanies() ?>
        <?php if (!empty($companies)): ?>
        <div class="block">
            <div class="panel-heading">
                <h4 class="panel-title">
                    <a data-toggle="collapse" href="#collapseCompany">
                        <i class="indicator fa fa-caret-down" aria-hidden="true" aria-expanded="true"></i>
                        <?= __('bus', 'Company') ?>
                    </a>
                </h4>
            </div>
            <div id="collapseCompany" class="panel-collapse collapse show filter-group" data-filter-group="company">
                <ul class="list-group">
                    <?php foreach ($companies as $id => $company): ?>
                    <li class="list-group-item">
                        <div class="checkbox">
                            <label>
                                <input type="checkbox" value="<?= $id ?>" data-filter="[data-company=<?= $id ?>]">
                                <span class="cr"><i class="cr-icon fa fa-check"></i></span>
                                <span title="<?= __('bus', $company) ?>" class="main-blue">
                                    <img src="<?= tools()->getMediaUrl('bus/'.tools()->getOptionValue('Bus', 'CompanyLogo', $id)) ?>" class="img-circle filters-icon">
                                    <?= __('bus', $company) ?>
                                </span>
                            </label>
                        </div>
                    </li>
                    <?php endforeach; ?>
                </ul>
            </div>
        </div>
        <?php endif ?>
        <script type="text/javascript">
            if (!(busSearchResultList instanceof codnitive.isotope)) {
                busSearchResultList = new codnitive.isotope();
                var busSearchResultListSort = busSearchResultList.init('.list.results .right-section', {});
            }
            busSearchResultList.rangeFilters = {
                'price': {'min': <?= $minPrice ?>, 'max': <?= $maxPrice ?>},
                'price_default': {'min': <?= $minPrice ?>, 'max': <?= $maxPrice ?>}
            };
            busSearchResultList.rangeFilters = {
                'departing': {'min': <?= $minDeparting ?>, 'max': <?= $maxDeparting ?>},
                'departing_default': {'min': <?= $minDeparting ?>, 'max': <?= $maxDeparting ?>}
            };
            busSearchResultListSort = busSearchResultList.initFilter(busSearchResultListSort);
            busSearchResultList.filterCheckbox(
                busSearchResultListSort, 
                '#collapseCompany, #collapseDropping, #collapseBoarding'
            );
            busSearchResultList.filterRange(busSearchResultListSort, '#price_range_slider');
            busSearchResultList.filterRange(busSearchResultListSort, '#departing_range_slider');
        </script>
    </div>
</div>
